---
title: "R Notebook: Stringmatch"
# output: html_notebook
output: none
---


# Load data files
```{r}
library(tidyverse)

# specify the directory where the files are located
dir_path <- "~/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/OCED_AOML/WS_cruises/plankton_imaging/CPICS/TS.Master_selection"

# obtain a list of file names in the directory
file_names <- list.files(path = dir_path, pattern = ".txt", full.names = TRUE)

# loop over each file and import the tables (use this for DATES)
for (file in file_names) {
  table_name <- gsub(".txt", "", basename(file)) # get the name of the table from the file name
  assign(table_name, read.table(file = file, header = FALSE, sep = "\t") %>%
           mutate(date = as.POSIXct(substr(V1, start = 24, stop = 36), format="%Y%m%d_%H%M", tz="UTC")))
}

```


# Match file name using DATE values
```{r}
library(lubridate)

dir_path2 <- "~/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/OCED_AOML/WS_cruises/plankton_imaging/CPICS/ws_cruise_ctd"

file_name <- list.files(path = dir_path2, pattern = "ctd_meta_v4.csv", full.names = TRUE)
ctd_meta <- read.csv(file_name, fill = TRUE)

# USE WITH ctd_meta_v4.csv
dt_list <- as.POSIXct(paste(ctd_meta$year,
                            sprintf("%02d", ctd_meta$month),
                            sprintf("%02d", ctd_meta$day),
                            ctd_meta$time_gmt),
                      format = "%Y%m%d %I:%M:%S %p",
                      tz = "UTC")

################################################################################################################
# This section detects short transit times between stations

# Calculate time differences in seconds between consecutive dt_list objects
time_differences <- as.numeric(difftime(dt_list[-1], dt_list[-length(dt_list)], units = "secs"))

# Convert time differences from seconds to minutes
time_differences_mins <- time_differences / 60

# Create a data frame showing the original times and their differences in minutes
time_diff_df <- data.frame(
  start_time = dt_list[-length(dt_list)],
  end_time = dt_list[-1],
  time_difference_mins = time_differences_mins
)

# find CTD time stamps of consecutive stations within less than 20 min. This will identify CTD casts that are close to each other
short_t_idx <- which(time_diff_df$time_difference_mins < 20)
short_timestamps <- dt_list[short_t_idx]
#################################################################################################################

# Create empty data frame to store results
conc_occ_final <- data.frame(date = character(), count = numeric())

# List of class objects to be processed
class_names <- c("Acantharea", "Centric", "Ceratium", "Chaetoceros", "Chaetognaths", 
                 "Chain2", "Chain3", "Ostracods", "Copepods", "Decapods", "Echinoderms", 
                 "Guinardia", "Jellies", "Larvaceans", "Neocalyptrella", "Noctiluca", 
                 "pellets", "Polychaets", "Pteropods", "Tricho")

# time buffer before and after CTD time in seconds so that CPICS records are matched to CTD times.
start <- 10 * 60 
stop <- 10 * 60 

# Define the date limit
date_limit <- as.POSIXct("2024-11-30", tz = "UTC")

# Iterate over dt_list intervals
for (i in 1:length(dt_list)) {
  
  # Initialize a list to store counts for the current interval
  counts_list <- list(date = dt_list[i])
  
  # Iterate over each class object and perform subsetting
  for (class_name in class_names) {
    class_data <- get(paste0("class.", class_name))  # Dynamically get the class data frame
    
    # Filter out rows with dates after the date limit
    class_data <- subset(class_data, date <= date_limit)
    
    if (i < length(dt_list)) {
      # Subsetting for all intervals except the last one
      subset_data <- subset(class_data, date >= dt_list[i]-start & date < dt_list[i+1]-stop)
    } else {
      # Subsetting for the last interval: capture all data greater than or equal to the last dt_list
      subset_data <- subset(class_data, date >= dt_list[i]-start)
    }
    
    counts_list[[class_name]] <- nrow(subset_data)
  }
  
  # Convert counts_list to a data frame and bind it to the result
  result <- as.data.frame(counts_list)
  conc_occ_final <- rbind(conc_occ_final, result)
} 

# Combine with ctd_meta
taxa_meta <- cbind(ctd_meta, conc_occ_final)

# Set sample_vol_per_min to a single value
taxa_meta$sampled_vol_per_min <- max(taxa_meta$sampled_vol_per_min, na.rm = TRUE)
# Set total_vol_sampled to common sample_vol_per_min 
taxa_meta <- taxa_meta %>%
  mutate(total_vol_sampled = sampled_vol_per_min * conc_deployDurMin)

################################################################################
# Check for unaccounted CPICS records 

# Initialize a list to store unaccounted dates for each class
unaccounted_dates_list <- list()

# Iterate over each class object
for (class_name in class_names) {
  # Get the date-time objects from the current class
  sel_class_dates <- get(paste0("class.", class_name))$date
  
  # Initialize a logical vector to track whether each class date is accounted for
  is_accounted_for <- rep(FALSE, length(sel_class_dates))
  
  # Check each class date against the intervals in dt_list
  for (i in 1:length(dt_list)) {
    if (i < length(dt_list)) {
      # Check all intervals except the last one
      interval_start <- dt_list[i] - start
      interval_end <- dt_list[i + 1] - stop
    } else {
      # Last interval captures all data greater than or equal to the last dt_list
      interval_start <- dt_list[i] - start
      interval_end <- date_limit  # Use date limit above
    }
    
    # Mark class dates that fall within the current interval as accounted for
    is_accounted_for <- is_accounted_for | (sel_class_dates >= interval_start & sel_class_dates < interval_end)
  }
  
  # Subset the class dates that were not accounted for
  unaccounted_sel_class_dates <- sel_class_dates[!is_accounted_for]
  
  # Store the unaccounted dates in the list
  unaccounted_dates_list[[class_name]] <- unaccounted_sel_class_dates
}

# Print or view the unaccounted dates for each class
for (class_name in class_names) {
  cat("Unaccounted dates for class:", class_name, "\n")
  print(unaccounted_dates_list[[class_name]])
  cat("\n")
}

# # Percent of sampling events with a seascape class match and other stats
sampling_events_img <- sum(!is.na(taxa_meta$total_vol_sampled))
sampling_events_no_img <- sum(is.na(taxa_meta$total_vol_sampled))
seascape_no_match_img <- sum(is.na(taxa_meta$X8.day.seascapes) & !is.na(taxa_meta$total_vol_sampled))
seascape_total <- sum(!is.na(taxa_meta$X8.day.seascapes))
no_seascape <- sum(is.na(taxa_meta$X8.day.seascapes))
seascape_match <- sum(!is.na(taxa_meta$X8.day.seascapes) & !is.na(taxa_meta$total_vol_sampled))
percent_match <- round(seascape_match/sampling_events_img*100, digits = 0)
# Calculates number of stations occupied during each cruise
station_num_per_cruise <- tapply(taxa_meta$Station, taxa_meta$cruiseID, function(x) length(unique(x)))

sampling_events_total <- paste("Total number CTD casts:", nrow(taxa_meta))
matched_casts <- paste("Percent of CTD casts with seascape match:", round(seascape_total/nrow(taxa_meta)*100, digits=0), "%")
sampling_success <- paste("Percent of CTD casts with images (image profiles):", round(sampling_events_img/nrow(taxa_meta)*100, digits=0), "%")
match_stat <- paste("Percent of image profiles matched to seascapes:", percent_match, "%")
print(sampling_events_total)
print(matched_casts)
print(sampling_success)
print(match_stat)
print(as.table(station_num_per_cruise))

```

# # Calculate plankton concentration time series per station or over the entire region
```{r}
# Calculate species concentration (counts/ml) for each species

# # For zooplankton
taxa_meta_concentration <- taxa_meta %>%
  mutate(across(c(Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,Jellies,
    Larvaceans,Polychaets,Pteropods), ~ ./total_vol_sampled * 1e6)) %>%
  select(Station, dec_lat, dec_lon, year, month, date, Avg.chl.a..ug.L.,
         temp..degC., salinity, total_vol_sampled,
         Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,
         Jellies,Larvaceans,Polychaets,Pteropods) %>%
  filter(!is.na(total_vol_sampled))

# # Transform taxa_meta_concentration to long format
taxa_meta_long <- taxa_meta_concentration %>%
  pivot_longer(cols = c(Acantharea, Chaetognaths,Ostracods,Copepods,Decapods,
                        Echinoderms, Jellies, Larvaceans,Polychaets, Pteropods),
               names_to = "species", values_to = "species_concentration")

# # For phytoplankton
# taxa_meta_concentration <- taxa_meta %>%
#   mutate(across(c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
#                   Noctiluca,Tricho), ~ ./total_vol_sampled * 1e6)) %>%
#   select(Station, dec_lat, dec_lon, year, month, date, Avg.chl.a..ug.L.,
#          temp..degC., salinity,total_vol_sampled,
#          Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
#                   Noctiluca,Tricho) %>%
#   filter(!is.na(total_vol_sampled))
# 
# # # Transform taxa_meta_concentration to long format
# taxa_meta_long <- taxa_meta_concentration %>%
#   pivot_longer(cols = c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
#                   Noctiluca,Tricho),
#                names_to = "species", values_to = "species_concentration")

# Filter the data for Stations
station_list_fk <- c("WS","21/LK","MR","16","18","10","12","9.5","9","7","2")
# station_list_sr <- c("68","65","64","60","58","57.3","57.2","57.1","57","56","55","54","53","51",
#                   "49","47","45","41","30","31","33")
# station_list_cal <- c("CAL5","CAL4","CAL3","CAL2","CAL1","RP1","RP2","RP3","RP4","GP5","BG4","BG3",
#                   "BG2","BG1","BG6", "BG7")
# station_list_vl <- c("V1","V2","V3","V4","V5","V6","V7","V8","V9","L1","L3","L5","L7","L9")
# station_list_tb <- c("AMI9","AMI8","AMI7","AMI6","AMI5","AMI4","AMI3","AMI2","AMI1","TB1","TB2",
#                   "TB3","TB4","TB5","TB10","CW4","CW3","CW2","CW1")
# station_selected <- "WS"

# # station_list_per_isobath.csv is generated by the Matlab script sfer_sta_mapper.m (ws_cruises folder)
station_list_bathy <- read.csv("station_list_per_isobath.csv", fill = TRUE)
colnames(station_list_bathy) <- c("20m", "50m", "200m")
# Combine all stations from station_list_bathy into a single character vector
all_stations_bathy <- unique(unlist(station_list_bathy))
# Get the unique station names from taxa_meta
all_stations_taxa <- unique(taxa_meta$Station)
# Find stations in taxa_meta$Station not present in station_list_bathy 
stations_not_in_taxa <- setdiff(all_stations_taxa, all_stations_bathy)

# # filter the data using station lists and selected year
# filtered_taxa_meta_long <- taxa_meta_long %>%
#   filter(Station %in% station_list_fk) %>%
#   filter(year > 2023) %>%
#   filter(species_concentration > 0)

# filter the data using station station_list_bathy
# filtered_taxa_meta_long <- taxa_meta_long %>%
# filter(Station %in% station_list_bathy[, 2])

# # Without filtering per group of stations but looking at the entire region
filtered_taxa_meta_long <- taxa_meta_long

# Calculate mean and standard deviation of species concentration for each date
summary_data <- filtered_taxa_meta_long %>%
  group_by(year, month, species) %>%
  summarise(mean_concentration = mean(species_concentration, na.rm = TRUE),
            sd_concentration = sd(species_concentration, na.rm = TRUE),
            earliest_day = min(as.numeric(format(date, "%d")), na.rm = TRUE)) %>%
  ungroup()

# Combine year and month columns into a single date column
summary_data$date <- as.Date(paste(summary_data$year, summary_data$month, summary_data$earliest_day, sep = "-")) 

spp_colors_zoopl <- c("#551F00FF", "#889D35FF", "#DF7700FF", "#F5B642FF","#FFF179FF","#C3F4F6FF", "#6AD5E8FF", "#32B2DAFF", "#7992A6FF", "#C0D1CEFF")
spp_colors_phyto <- c("#B4B87FFF", "#9C913FFF", "#585B33FF", "#6EA8ABFF", "#397893FF", "#31333FFF", "#8F5715FF", "#BA9A44FF", "#CFBB83FF")

# # Check dominance of groups by calculating the overall mean 
# test <- summary_data %>% filter(species == "Polychaetes") %>% summarize(avg = mean(mean_concentration))
# mean(test$avg)

# Plot time series of mean+sd planton concentration per group of sites
# zz <- ggplot(summary_data, aes(x = date, y = mean_concentration, fill = species)) +
#   geom_bar(stat = "identity", alpha = 0.7) +
#   scale_fill_manual(values = spp_colors_phyto) +
#   # geom_errorbar(aes(ymin = 0, ymax = mean_concentration + sd_concentration),
#   #               position = position_dodge(width = 0.9), width = 0.2) +
#   labs(x = "Date", y = expression("Mean density (org. m"^"-3"~")"), fill = "Species") +
#   # scale_x_continuous(breaks = 1:12, labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
#   #                                              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) + 
#   theme_minimal() +
#     theme(axis.text.x = element_text(size = 18, color = "black"),
#           axis.title = element_text(size = 18, color = "black"),
#           axis.text.y = element_text(size = 18, color = "black")) +
#     theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#     theme(axis.line = element_line(color = "black")) 
# zz

# Filter summary_data for selected only
# Acantharea, Copepods, Echinoderms, Jellies, Larvaceans, Chaetognaths, Polychaets, Pteropods, Ostracods
# Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,Noctiluca,Tricho

selected_group <- "Copepods"

summary_selected <- filtered_taxa_meta_long %>%
  filter(species == selected_group) %>%
  filter(species_concentration > 0) %>%
  group_by(year, month) %>%
  mutate(earliest_day = min(as.numeric(format(date, "%d")), na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(date = as.Date(paste(year, month, earliest_day, sep = "-"))) %>%
  select(-earliest_day)  # Optionally, remove the 'earliest_day' column if not needed
print(paste0('Maximum concentration value:', max(summary_selected$species_concentration)))
print(paste0('Maximum seawater temperature:', max(summary_selected$temp..degC.)))
print(paste0('Minimum seawater temperature:', min(summary_selected$temp..degC.)))

# Create a vector of date labels
unique_dates <- sort(unique(summary_selected$date))  # Get unique dates
unique_dates <- format(unique_dates, "%Y-%m")
custom_date_labels <- as.character(unique_dates)

# Create the time series boxplot
  sel_box <-  ggplot(summary_selected, aes(x = as.factor(date), y = species_concentration)) +
    geom_boxplot(fill = "white", notch = FALSE, outlier.shape = NA) +
    # geom_violin(fill = "lightgrey", color = "NA", alpha = 0.7) +
    # geom_jitter(aes(color = factor(Station), size = temp..degC.), alpha = 0.9) +
    # geom_jitter(width = 0.25, aes(color = temp..degC., size = salinity), alpha = 0.6) + # with salinity included
    geom_jitter(width = 0.25, aes(color = temp..degC.), size = 3, alpha = 0.6) +
    labs(x = "Date", y = expression("Density (org. m"^"-3"~")")) +
    scale_color_viridis_c(name = "Temperature (°C)", option = "inferno", limits = c(14, 34)) +
    scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(1e2, 1e5)) +
    scale_x_discrete(labels = custom_date_labels) +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 18, color = "black"),  # Set X-axis label font size
          axis.text.y = element_text(size = 18, color = "black")) +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(size = 18, color = "black")) +
    theme(legend.text = element_text(size = 14),
          legend.title = element_text(size = 16, color = "black")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(axis.line = element_line(color = "black")) 
  sel_box

sel_bar <- ggplot(summary_selected, aes(x = as.factor(date), y = species_concentration)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.4) +
  labs(title = "Total Copepod Density at Site WS",
       x = "Date",
       y = expression("Total ind. m"^"-3")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  
# Save figure as a svg file  
# ggsave(paste0("conc_time-series_1-50m_", selected_group, ".svg"), plot = sel_box, width = 10, height = 8, device = "svg")

# # Create seasonal boxplots
# Step 1: Define seasons based on the month column
summary_selected <- summary_selected %>%
  mutate(season = case_when(
    month %in% c(1, 2, 3) ~ "Winter",
    month %in% c(4, 5, 6) ~ "Spring",
    month %in% c(7, 8, 9) ~ "Summer",
    month %in% c(10, 11, 12) ~ "Fall"
  ))

# Step 2: Convert season to a factor with specified order
summary_selected$season <- factor(summary_selected$season, levels = c("Winter", "Spring", "Summer", "Fall"))

# color order zooplankton: 1: Rhizaria spp, 2: Chaetognaths, 3: Copepods, 4: Decapods, 5: Echinoderms, 6: Gelatinous, 7: Larvaceans, 8: Ostracods, 9: Polychaetes, 10: Pteropods
# color order phytoplankton: 1: Coscinodiscus, 2: Neoceratium, 3: Chaetoceros, 4: Chain diatoms, 5: Skeletonema , 6: Guinardia striata, 7: Neocalyptrella, 8: Hemidiscus, 9: Trichodesmium

# Step 3: Create the box plot
  season_boxplot <- ggplot(summary_selected, aes(x = season, y = species_concentration)) +
    geom_boxplot(fill = spp_colors_phyto[3], notch = TRUE) +
    labs(x = "Season", y = expression("Density (org. m"^"-3"~")")) +
    scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(1e2, 1e6)) +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 32, color = "black"),
          axis.title = element_text(size = 32, color = "black"),
          axis.text.y = element_text(size = 32, color = "black")) +
    theme(axis.line = element_line(color = "black")) 
  season_boxplot
  
# Save figure as a svg file  
# ggsave(paste0("boxplot_seasonal_", selected_group, ".svg"), plot = season_boxplot, width = 10, height = 10, device = "svg")

# # Creates tidyplot boxplot    
library(tidyplots)
library(ggplot2)
tidy_plot <- summary_selected %>%
  tidyplot(x = season, y = species_concentration, color = season) %>%
  add_boxplot(alpha = 0.6, linewidth = 0.5, outlier.size = 3) %>%
  add_test_pvalue(ref.group = 3, hide_info = TRUE, label.size = 8) %>%
  adjust_size(width = 20, height = 20, unit = "cm")

# Add log scale to the y-axis
tidy_plot2 <- tidy_plot + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(1e2,1e9)) +
  labs(x = "Season", y = expression("Density (org. m"^"-3"~")")) +
  theme_minimal() +
    theme(axis.text.x = element_text(size = 32, color = "black"),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 32, color = "black"),
          axis.text.y = element_text(size = 32, color = "black")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(axis.line = element_line(color = "black")) +
    theme(legend.position = "none")
tidy_plot2

# Save figure as a svg file  
# ggsave(paste0("tidyplot_seasonal_", selected_group, ".svg"), plot = tidy_plot2, width = 10, height = 10, device = "svg")
  
# # Plot concentration time series for all selected sites
# kk <- ggplot(summary_selected, aes(x = date, y = species_concentration, shape = factor(Station))) +
#   labs(x = "Date", y = "Species concentration (org.m-3)") +
#   geom_point(aes(size = temp..degC.), fill = "darkgrey") + # or colour = factor(Station)
#   scale_shape_manual(values = c(0, 1, 2, 3, 4, 5, 6))
# kk

# kk <- ggplot(summary_selected, aes(x = date, y = species_concentration, colour = factor(Station))) +
#   labs(x = "Date", y = "Species concentration (org.m-3)") +
#   geom_point(aes(size = temp..degC.), alpha = 0.7) + # or colour = factor(Station) +
#   # geom_smooth(method = "lm", formula = y ~ poly(x, 4), se = FALSE) + # Add polynomial fit line
#   scale_colour_brewer(palette = "Set1")
# kk
  
# # Find the index of the last row with date == '2023-01-15' and add a dummy row for missing dates
# new_row <- tibble(Station = NA, dec_lat = NA, dec_lon = NA, year = NA,
#                   month = NA, date = as.Date('2023-03-15'), Avg.chl.a..ug.L. = NA,
#                   temp..degC. = NA, salinity = NA, species = NA, species_concentration = NA)
# last_index <- max(which(summary_selected$date == as.Date('2023-01-15')))
# summary_selected <- bind_rows(
#     summary_selected[1:last_index, ],
#     new_row,
#     summary_selected[(last_index + 1):nrow(summary_selected), ]
#   )
  
```

# # Calculates total plankton concentrations aggregating data from selected stations (eg FK)
```{r}
# Calculate plankton concentration for all species summed up
# For Phyto
taxa_meta_concentration_all <- taxa_meta %>%
  mutate(total_concentration = (
    Centric + Ceratium + Chaetoceros + Chain2 + Chain3 + Guinardia + Neocalyptrella +
    Noctiluca + Tricho) / total_vol_sampled * 1e6) %>%
  select(Station, dec_lat, dec_lon, year, month, date, Avg.chl.a..ug.L.,
         temp..degC., salinity, total_vol_sampled, total_concentration) %>%
  filter(!is.na(total_vol_sampled))

# # For Zooplankton
# taxa_meta_concentration_all <- taxa_meta %>%
#   mutate(total_concentration = (
#     Acantharea + Chaetognaths + Ostracods + Copepods + Decapods + Echinoderms + Jellies +
#     Larvaceans + Polychaets + Pteropods) / total_vol_sampled * 1e6) %>%
#   select(Station, dec_lat, dec_lon, year, month, date, Avg.chl.a..ug.L.,
#          temp..degC., salinity, total_vol_sampled, total_concentration) %>%
#   filter(!is.na(total_vol_sampled))

# Filter the data for Stations
station_list_fk <- c("WS","21/LK","MR","16","18","10","12","9.5","9","7","2")
filtered_taxa_conc_all <- taxa_meta_concentration_all %>%
  filter(Station %in% station_list_fk)

# Aggregate total concentration and total volume sampled per year and month
aggregated_concentration <- filtered_taxa_conc_all %>%
  group_by(year, month) %>%
  summarise(
    total_counts = sum(total_concentration * total_vol_sampled / 1e6, na.rm = TRUE), # Sum up all counts
    total_vol_sampled = sum(total_vol_sampled, na.rm = TRUE), # Sum up all volume sampled
    mean_temp_degC = mean(temp..degC., na.rm = TRUE), # Calculate mean temperature
    mean_salinity = mean(salinity, na.rm = TRUE), # Calculate mean salinity
    mean_chla = mean(Avg.chl.a..ug.L., na.rm = TRUE) 
  ) %>%
  ungroup() %>%
  mutate(total_concentration = (total_counts / total_vol_sampled) * 1e6) # Recalculate the concentration

# Create a Date column for plotting purposes
aggregated_concentration <- aggregated_concentration %>%
  mutate(year_month = as.Date(paste(year, month, "01", sep = "-")))

# Create the time series plot
concentration_ts <- ggplot(aggregated_concentration, aes(x = year_month)) +
  geom_line(aes(y = total_concentration), color = "blue", size = 1) + # Line plot for total concentration
  geom_point(aes(y = total_concentration), color = "red", size = 2) +  # Points for total concentration
  # geom_line(aes(y = (mean_temp_degC - 20) / (35 - 20) * max(total_concentration)), 
  #           color = "orange", size = 1) +  # Line plot for temperature (normalized)
  labs(title = "Total Phytoplankton Concentration Time Series",
       x = "Date",
       y = expression("Total Concentration (org/m"^3~")")) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +  # Show ticks for every month
  scale_y_continuous(
    name = expression("Total Concentration (org/m"^3~")"),            # Primary y-axis label
    # sec.axis = sec_axis(~ . * (35 - 20) / max(aggregated_concentration$total_concentration) + 20, 
    #                     name = "Temperature (°C)", 
    #                     breaks = seq(20, 35, by = 5))  # Secondary y-axis label
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    # axis.title.y.right = element_text(color = "orange"),  # Color the secondary y-axis label
    # axis.line.y.right = element_line(color = "orange"),    # Color the secondary y-axis line   
    # panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    # panel.border = element_blank()       # Remove panel border if necessary
  )

# Print the plot
concentration_ts
```

# # Calculate plankton concentrations per seascape class
```{r}
library(paletteer)

spp_df <- taxa_meta[ , c("X8.day.seascapes", "total_vol_sampled", "date",
                         "Acantharea",
                         "Chaetognaths",
                         "Copepods",
                         "Decapods",
                         "Echinoderms",
                         "Jellies",
                         "Larvaceans",
                         "Ostracods",
                         "Polychaets",
                         "Pteropods")]

# spp_df <- taxa_meta[ , c("X8.day.seascapes", "total_vol_sampled", "date",
#                          "Centric",
#                          "Ceratium",
#                          "Chaetoceros",
#                          "Chain2",
#                          "Chain3",
#                          "Guinardia",
#                          "Neocalyptrella",
#                          "Noctiluca",
#                          "Tricho")]

# Remove rows with NaN values in X8.day.seascapes and total_vol_sampled
spp_df <- subset(spp_df, !is.na(X8.day.seascapes) & !is.na(total_vol_sampled))

# Calculate total counts per species within each X8.day.seascapes category
spp_count_per_seascape <- spp_df %>%
  gather(key = "species", value = "count", -(X8.day.seascapes:date)) %>%
  group_by(X8.day.seascapes, species) %>%
  summarise(total_count = sum(count)) %>%
  ungroup()

# Calculate total volume sampled per X8.day.seascapes category
total_vol_per_seascape <- spp_df %>%
  group_by(X8.day.seascapes) %>%
  summarise(total_vol_sampled = sum(total_vol_sampled))

# Merge total counts and total volume data frames
spp_concentration <- merge(spp_count_per_seascape, total_vol_per_seascape, by = "X8.day.seascapes")

# Calculate species per cubic meter: might be misleading since it integrates all counts and sampled volumes across cruises to calculate concentrations. It is likely better to use average concentrations as below.
spp_concentration$species_per_cubic_meter <- spp_concentration$total_count / spp_concentration$total_vol_sampled * 1e6

# # Select desired seascapes and reorder categories in X axis
spp_concentration$X8.day.seascapes <- factor(spp_concentration$X8.day.seascapes, levels = c("3", "11", "13", "15","21","27"))

# Create the stack plot
concentration_stackplot <- ggplot(spp_concentration, aes(x = X8.day.seascapes, y = species_per_cubic_meter, fill = species)) +
  geom_bar(stat = "identity") +
  scale_fill_paletteer_d("MetBrewer::Degas") +
  labs(x = "Seascape class", y = "Species concentration (org. m"^"-3"~")") +
theme_minimal() +
  theme(axis.text.x = element_text(size = 18),  # Set X-axis label font size
        axis.text.y = element_text(size = 18)) +
  theme(axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18)) +
  theme(legend.text = element_text(size = 16))
concentration_stackplot

# Calculate percentages
spp_concentration_percent <- spp_concentration %>%
  group_by(X8.day.seascapes) %>%
  mutate(total_concentration = sum(species_per_cubic_meter),
         species_percentage = (species_per_cubic_meter / total_concentration) * 100)

# Create the stacked plot
concentration_percent_stackplot <- ggplot(spp_concentration_percent, aes(x = X8.day.seascapes, y = species_percentage, fill = species)) +
  geom_bar(stat = "identity") +
  scale_fill_paletteer_d("MetBrewer::Degas") +
  labs(x = "Seascape class", y = "Relative concentration (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 18),  # Set X-axis label font size
        axis.text.y = element_text(size = 18)) +
  theme(axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18)) +
  theme(legend.text = element_text(size = 16))
concentration_percent_stackplot

# Gather columns containing species counts into key-value pairs and calculate concentrations
spp_concentration_long <- spp_df %>%
  gather(key = "species", value = "count", -(X8.day.seascapes:date)) %>%
  mutate(concentration = (count / total_vol_sampled) * 1e6)

# Calculate the mean concentration and its standard deviation per species and 8X.day.seascapes category. This is likely more representative since the approach will capture high concentration events (high counts in low volumes) that otherwise get filtered out when using an overall integrated sampled volume and total counts for the total concentration.
avg_concentration_per_class <- spp_concentration_long %>%
  filter(concentration > 0) %>%
  group_by(species, `X8.day.seascapes`) %>%
  summarize(
    mean_concentration = mean(concentration, na.rm = TRUE)/1000, # the 1000 term is for plotting simplicity
    sd_conconcentration = sd(concentration, na.rm = TRUE)
  )

avg_concentration_per_class$X8.day.seascapes <- factor(avg_concentration_per_class$X8.day.seascapes, levels = c("3", "11", "13", "15","21","27"))

seascape_labels = c("TST", "TSU", "SGMI", "TS", "WBHN", "HE")

# seascape classes: 
# 3:Tropical/Subtrop. Trans.| 5: Subtrop. Gyre Trans | 7: Temperate Trans | 11: Tropical/Subtrop. Upwelling | 13: Subtrop. Gyre Mesos. Influenced | 15: Tropical Seas | 21: Warm Bloom High Nutrients | 27: Hypersal. Eutrophic

# Reorder factor levels based on mean_concentration values
species_order <- avg_concentration_per_class %>%
  group_by(species) %>%
  summarise(mean_conc = mean(mean_concentration, na.rm = TRUE)) %>%
  arrange(mean_conc) %>%
  pull(species)

# Apply the new ordering to the species column
avg_concentration_per_class$species <- factor(avg_concentration_per_class$species, levels = species_order)

# rename species as needed
species_order <- recode(species_order,
                        "Polychaets" = "Polychaetes",
                        "Acantharea" = "Acantharea spp",
                        "Jellies" = "Gelatinous")

# species_order <- recode(species_order,
#                         "Noctiluca" = "Hemidiscus spp",
#                         "Ceratium" = "Neoceratium spp",
#                         "Tricho" = "Trichodesmium spp",
#                         "Neocalyptrella" = "Neocalyptrella spp",
#                         "Chaetoceros" = "Chaetoceros spp",
#                         "Centric" = "Coscinodiscus spp",
#                         "Guinardia" = "Guinardia striata",
#                         "Chain2" = "Mixed Chain Diatoms",
#                         "Chain3" = "Skeletonema spp")

spp_labels <- species_order
spp_colors_zoopl <- c("#551F00FF", "#889D35FF", "#DF7700FF", "#F5B642FF","#FFF179FF","#C3F4F6FF", "#6AD5E8FF", "#32B2DAFF", "#7992A6FF", "#C0D1CEFF")
spp_colors_phyto <- c("#B4B87FFF", "#9C913FFF", "#585B33FF", "#6EA8ABFF", "#397893FF", "#31333FFF", "#8F5715FF", "#BA9A44FF", "#CFBB83FF")
# spp_colors_phyto <- c("#C969A1FF", "#CE4441FF", "#EE8577FF", "#EB7926FF", "#FFBB44FF", "#859B6CFF", "#62929AFF", "#004F63FF", "#122451FF")

font_size = 32
avg_stackplot <- ggplot(avg_concentration_per_class, aes(x = X8.day.seascapes, y = mean_concentration, fill = species)) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_fill_manual(
    values = spp_colors_zoopl,
    # values = spp_colors_phyto,
    labels = spp_labels) +
  ylim(0, 15) +
  scale_x_discrete(labels = seascape_labels) +
  labs(x = "Seascape class", y = expression("Density (org. m"^"-3"~") × 10"^3)) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = font_size, color = "black"),
        axis.title.x = element_text(size = font_size, color = "black"),
        axis.text.y = element_text(size = font_size, color = "black"),
        axis.title.y = element_text(size = font_size, color = "black", margin = margin(r = 24)), 
        axis.line = element_line(color = "black"),
        legend.text = element_text(size = font_size),
        legend.position = "none")
avg_stackplot

ggsave("abund_zoopl_v3.svg", plot = avg_stackplot, width = 14, height = 8, device = "svg")

# Calculate percentages
avg_concentration_percent <- avg_concentration_per_class %>%
  group_by(`X8.day.seascapes`) %>%
  mutate(mean_concentration_percent = mean_concentration / sum(mean_concentration) * 100)

avg_percent_stackplot <- ggplot(avg_concentration_percent, aes(x = X8.day.seascapes, y = mean_concentration_percent, fill = species)) +
  geom_bar(stat = "identity", width = 0.75) +
  scale_fill_manual(
    values = spp_colors_zoopl,
    # values = spp_colors_phyto,
    labels = spp_labels) +
  scale_x_discrete(labels = seascape_labels) +
  labs(x = "Seascape class", y = "Relative concentration (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = font_size, color = "black"),
    axis.title = element_text(size = font_size, color = "black"),
    axis.text.y = element_text(size = font_size, color = "black")) +
  theme(axis.line = element_line(color = "black")) +
  theme(legend.text = element_text(size = font_size)) 
  # theme(legend.position = "none")
avg_percent_stackplot

# ggsave("legend_phyto_v3.svg", plot = avg_percent_stackplot, width = 14, height = 8, device = "svg")

# Palettes (https://r-graph-gallery.com/color-palette-finder):
# use for zooplankton (8 categories):
# scale_fill_paletteer_d("MoMAColors::Abbott")
# scale_fill_manual(values = custom_pal_hex2) 
# scale_fill_paletteer_d("MetBrewer::Homer1")
# scale_fill_paletteer_d("MoMAColors::Lupi")
# scale_fill_paletteer_d("MetBrewer::Nizami")
# scale_fill_paletteer_d("colorblindr::OkabeIto")
# Home1: #551F00FF, #A62F00FF, #DF7700FF, #F5B642FF, #FFF179FF, #C3F4F6FF, #6AD5E8FF, #32B2DAFF

# use for phytoplankton (7 categories):
# scale_colour_brewer(palette = "Set2") 
# scale_fill_paletteer_d("MetBrewer::Archambault") + # use for phytoplankton (Archambault, Austria)
# scale_fill_paletteer_d("Manu::Kea") 
# scale_fill_paletteer_d("ghibli::MononokeMedium")
# scale_fill_paletteer_d("NatParksPalettes::SmokyMtns")
# #42511AFF, #889D35FF, #D3D175FF, #B50200FF, #DA6C41FF, #7C6E66FF, #BCAFA6FF

```


# Generate plots 
```{r}
library(hrbrthemes)
library(viridis)

# # Load seascape color palette used with Matlab and extract RGB values for observed unique seascapes
# For NOAA machines
# palette_dir <- "/Users/enrique.montes/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/software/matlab/m_map/seascape_cm"
# For personal machine
palette_dir <- "~/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/software/matlab/m_map/seascape_cm"
palette_file <- list.files(path = palette_dir, pattern = "cmap1.csv", full.names = TRUE)
palette_df <- read.csv(palette_file, header = FALSE)
colnames(palette_df) <- c("r", "g", "b")
unique_seascapes <- sort(unique(na.omit(ctd_meta$X8.day.seascapes)))
subset_palette_df <- palette_df[unique_seascapes, ]

# set RGB values for the plots (for rainbow)
r_vals <- round(subset_palette_df$r * 255, 0)
g_vals <- round(subset_palette_df$g * 255, 0)
b_vals <- round(subset_palette_df$b * 255, 0)
custom_pal <- cbind(r_vals, g_vals, b_vals)
custom_pal_hex <- rgb(custom_pal[, 1], custom_pal[, 2], custom_pal[, 3], maxColorValue=255)
# pal_final <- c(custom_pal_hex[3], custom_pal_hex[4], custom_pal_hex[5], )

# filter out rows with NA values in column seascapes
df_filtered <- taxa_meta[complete.cases(taxa_meta$X8.day.seascapes),]

# Convert the 'x' column to character
df_filtered$X8.day.seascapes <- as.character(df_filtered$X8.day.seascapes)

# # Reorder seascape categories in X axis
df_filtered$X8.day.seascapes <- factor(df_filtered$X8.day.seascapes, levels = c("3", "11", "13", "15","21","27"))

# Define custom colors for each level
# custom_colors <- c("3" = custom_pal_hex[1], "13" = custom_pal_hex[5], "15" = custom_pal_hex[6],
#                    "21" = custom_pal_hex[7], "27" = custom_pal_hex[8])

custom_colors <- c("3" = "#2A3F6E", "11" = "#3E92E0", "13" = "#B6E7E0FF", "15" = "#61BEA4", "21" = "#FFB651FF", "27" = "#D85A44FF")

# Filter out seascape class as desired
# df_filtered <- df_filtered[df_filtered$X8.day.seascapes != "5", ]

# Plot
# See https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html for color palette options
font_size = 36
pp <- df_filtered %>%
  ggplot( aes(x=X8.day.seascapes, y=temp..degC., fill=X8.day.seascapes)) +
    geom_boxplot() +
    # scale_fill_viridis(option="H", discrete = TRUE, alpha=0.6) +
    scale_fill_manual(values = custom_colors) +
    geom_jitter(color="grey", size=3, alpha=0.4) +
    scale_x_discrete(labels = seascape_labels) +
    scale_y_continuous(
        breaks = seq(15, 35, by = 5),
        labels = scales::label_number(accuracy = 1),
        limits = c(15, 35)
    ) +
    labs(x = "Seascape class") +
    # labs(y = expression("["*Chl-a*"]"~ mu*"g"~L^-1)) +
    # labs(y = expression("Salinity")) +
    labs(y = expression(paste("Temperature (", degree, "C)"))) +
    # labs(y = expression("["*DO*"]"~mg~L^-1)) +
    # labs(y = expression("["*NO["x"]*"]" ~ mu*"M")) +
    # labs(y = expression("["*PO[4]^"3-"*"]" ~ mu*"M")) +
    # labs(y = expression("["*NH[4]^"+"*"]" ~ mu*"M")) +
    # labs(y = expression("["*Si*"]" ~ mu*"M")) +
    # theme(axis.title.y = element_text(hjust = 1))
  theme_minimal() +
  theme(axis.text.x = element_text(size = font_size, color = "black"),
    axis.title = element_text(size = font_size, color = "black"),
    axis.text.y = element_text(size = font_size, color = "black"),
    axis.title.y = element_text(size = font_size, color = "black", margin = margin(r = 23))) +
  theme(axis.line = element_line(color = "black")) +
  theme(legend.position = "none")
pp

ggsave("temperature.svg", plot = pp, width = 14, height = 8, device = "svg")
```

# Create stackplots showing relative frequency using counts only of plankton taxa per seascape category
```{r}
# convert abundance columns to relative frequency

# subsets taxa for zooplankton
# df_subset <- df_filtered[ , c("X8.day.seascapes",
#                               "Acantharea",
#                               "Copepods",
#                               "Echinoderms",
#                               "Jellies",
#                               "Larvaceans",
#                               "Polychaetes",
#                               "Chaetognaths",
#                               "Pteropods")]

# subsets taxa for phytoplankton
df_subset <- df_filtered[ , c("X8.day.seascapes",
                            "Ceratium",
                            "Chaetoceros",
                            "Chain2",
                            "Chain3",
                            "Guinardia",
                            "Neocalyptrella",
                            "Tricho")]

# subsets taxa for all species
# df_subset <- df_filtered[ , c("X8.day.seascapes",
#                             "Ceratium",
#                             "Chaetoceros",
#                             "Diatoms",
#                             "Diatoms2",
#                             "Guinardia",
#                             "Neocalyptrella",
#                             "Trichodesmium",
#                             "Acantharea",
#                             "Copepods",
#                             "Echinoderms",
#                             "Jellies",
#                             "Larvaceans",
#                             "Polychaetes",
#                             "Chaetognaths",
#                             "Pteropods")]

# reshape the data to long format 
df_long <- tidyr::gather(df_subset, key = "Species", value = "Frequency", -X8.day.seascapes)

# calculate relative frequencies
df_sum <- df_long %>%
  group_by(X8.day.seascapes, Species) %>%
  summarise(n = sum(Frequency)) %>%
  mutate(freq = n / sum(n))

# Seascape class names:
# "Class 11" - Tropical/Subtropical Upwelling
# "Class 15" - Tropical Seas
# "Class 21" - Warm, Blooms, High Nuts
# "Class 3" - Tropical/Subtropical Transition
# "Class 7" - Temperate Transition

# # Select desired seascapes and reorder categories in X axis
df_sum$X8.day.seascapes <- factor(df_sum$X8.day.seascapes, levels = c("3", "5", "7", "11", "13", "15","21","27"))

# Filter out seascape class as desired
exclude_classes <- c(5, 7, 11)
df_sum <- df_sum[!df_sum$X8.day.seascapes %in% exclude_classes, ]

# Use qualitative palettes: https://colorbrewer2.org/#type=qualitative&scheme=Accent&n=7
custom_pal_hex2 <- c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf')
# custom_pal_hex2 <- c('#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02','#a6761d')

# create the stackplot
qq <- ggplot(df_sum, aes(x = X8.day.seascapes, y = freq, fill = Species)) +
  # scale_fill_viridis(option="Set3", discrete = TRUE, alpha=0.8) +
  scale_fill_viridis(discrete = TRUE, alpha=0.8) +
  # scale_fill_manual(values = custom_pal_hex2) +
  geom_bar(stat = "identity") +
  labs(x = "Seascape class") +
  labs(y = "Relative frequency") +
  # scale_x_discrete(labels= c("Tropical/Subtropical Upwelling", 
  #                            "Tropical Seas", 
  #                            "Warm, Blooms, High Nuts", 
  #                            "Tropical/Subtropical Transition", 
  #                            "Temperate Transition")) +
  # theme(axis.text.x = element_text(angle = 45)) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 18),  # Set X-axis label font size
        axis.text.y = element_text(size = 18)) +
  theme(axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18)) +
  theme(legend.text = element_text(size = 16)) 
  #theme(axis.text.x = element_text(hjust = 1))
qq
```


# Compute Shannon Index
```{r}
library(dplyr)
library(vegan)

# Select species for Shannon calculation
df_subset_shannon <- df_filtered[ , c("X8.day.seascapes",
                              "Acantharea",
                              "Copepods",
                              "Echinoderms",
                              "Jellies",
                              "Larvaceans",
                              "Polychaets",
                              "Chaetognaths",
                              "Pteropods",
                              "Ceratium",
                              "Chaetoceros",
                              "Chain2",
                              "Chain3",
                              "Guinardia",
                              "Neocalyptrella",
                              "Tricho")]

# reshape the data to long format
df_long <- tidyr::gather(df_subset_shannon, key = "Species", value = "Abundance", -X8.day.seascapes)

# Compute Shannon diversity per seascape class
shannon_df <- df_long %>% 
  group_by(X8.day.seascapes) %>% 
  summarise(shannon = diversity(Abundance, index = "shannon"))

# # Filter the data to exclude specified seascapes
# # Exclude seascapes
# exclude_seascapes <- c(5, 7, 11)
# shannon_df_filtered <- shannon_df[!shannon_df$X8.day.seascapes %in% exclude_seascapes, ]

# create the bar plot of Shannon diversity
ff <- ggplot(shannon_df, aes(x = X8.day.seascapes, y = shannon, fill = X8.day.seascapes)) +
  geom_bar(stat = "identity", width = 0.75) +
  # scale_fill_viridis(option="plasma", discrete = TRUE, alpha=0.6) +
  scale_x_discrete(labels = seascape_labels) +
  scale_fill_manual(values = custom_colors) +
  xlab("Seascape Class") +
  ylab("Shannon Diversity") +
  theme(axis.text.x = element_text(size = font_size),  # Set X-axis label font size
        axis.text.y = element_text(size = font_size)) +
  theme(axis.title.x = element_text(size = font_size),
        axis.title.y = element_text(size = font_size)) +
  theme(legend.text = element_text(size = font_size)) +
  guides()
ff

# # Subset the data to exclude specified seascapes
filtered_taxa_meta <- taxa_meta[complete.cases(taxa_meta$X8.day.seascapes), ]
# filtered_taxa_meta <- filtered_taxa_meta[!filtered_taxa_meta$X8.day.seascapes %in% exclude_seascapes, ]

# # Plot sampled seascape frequency
tt <- ggplot(filtered_taxa_meta, aes(x = factor(X8.day.seascapes), fill = factor(X8.day.seascapes))) +
  geom_bar(color = "black", alpha = 0.9, width = 0.75) +
  scale_fill_manual(values = custom_colors) +
  scale_x_discrete(labels = seascape_labels) +
  ylim(0, 500) +
  labs(x = "Seascape Class", y = "Frequency") +
  theme_minimal() +
    theme(axis.text.x = element_text(size = font_size),  # Set X-axis label font size
        axis.text.y = element_text(size = font_size)) +
  # theme(axis.title.x = element_text(size = font_size),
    theme(axis.title.x = element_blank(), 
        axis.title.y = element_text(size = font_size)) +
  theme(legend.text = element_text(font_size)) +
  theme(axis.line = element_line(color = "black")) +
  guides(fill = FALSE)
tt

# Calculate percent frequency of each X8.day.seascapes category
# see seascapes classes here: https://coastwatch.noaa.gov/cwn/products/seascape-pelagic-habitat-classification.html
percent_frequency <- filtered_taxa_meta %>%
  group_by(X8.day.seascapes) %>%
  summarise(count = n()) %>%
  mutate(percent_frequency = (count / sum(count)) * 100)
# Display the result
print(percent_frequency)

# # Counts of species per seascape
df_sum_abund <- df_long %>%
  group_by(X8.day.seascapes, Species) %>%
  summarise(n = sum(Abundance)) 
# Display the result
# print(df_sum_abund)

df_sum_abund_filt <- df_sum_abund[df_sum_abund$Species == "Larvaceans",]
# Filter the data to exclude specified seascapes
# df_sum_abund_filt2 <- df_sum_abund_filt[!df_sum_abund_filt$X8.day.seascapes %in% exclude_seascapes, ]

dd <- ggplot(df_sum_abund_filt, aes(x = factor(X8.day.seascapes), y = n, fill = factor(X8.day.seascapes))) +
  geom_bar(color = "black", alpha = 0.9, stat = "identity", width = 0.5) +
  # scale_fill_viridis(option = "magma", discrete = TRUE, alpha = 0.8)
  scale_fill_manual(values = custom_colors) +
  theme_minimal() 
dd

# Compute counts of selected species per seascape class normalized by frequency of seascapes
# reshape the data to long format
df_long2 <- tidyr::gather(df_subset_shannon, key = "Species", value = "Abundance", -X8.day.seascapes)

spp_seascape_normalized <- df_long2 %>%
  filter(Species == "Larvaceans") %>%
  group_by(X8.day.seascapes) %>%
  summarise(spp_count = sum(Abundance))

# Compute frequencies of each seascape class
seascape_frequencies <- df_long2 %>%
  count(X8.day.seascapes) %>%
  rename(freq = n)

# Merge counts with frequencies
spp_seascape_normalized <- merge(spp_seascape_normalized, seascape_frequencies, by = "X8.day.seascapes")

# Normalize counts by frequency
spp_seascape_normalized$spp_normalized <- (spp_seascape_normalized$spp_count / spp_seascape_normalized$freq) * 1000
# spp_seascape_normalized_filt <- spp_seascape_normalized[!spp_seascape_normalized$X8.day.seascapes %in% exclude_seascapes, ]

bb <- ggplot(spp_seascape_normalized, aes(x = factor(X8.day.seascapes), y = spp_normalized, fill = factor(X8.day.seascapes))) +
  geom_bar(color = "black", alpha = 0.9, stat = "identity", width = 0.5) +
  scale_fill_manual(values = custom_colors) +
  labs(x = "Seascape Class", y = "Counts / Seascape freq * 1000") +
  theme_minimal() +
  #   theme(axis.text.x = element_text(size = 32),  # Set X-axis label font size
  #       axis.text.y = element_text(size = 32)) +
  theme(axis.title.x = element_text(size = 32),
        axis.title.y = element_text(size = 32)) +
  # theme(legend.text = element_text(size = 32)) +
  guides()
bb

ggsave("seascape_freq.svg", plot = tt, width = 14, height = 8, device = "svg")

```

# PC plot
```{r}
library(ggalt)

# Perform principal component analysis on the count data

# for hydrography
sel_vars <- c(
  "X8.day.seascapes",
  "salinity",
  "Avg.chl.a..ug.L.",
  "PO4...uM.",
  "NO3.NO2..uM.",
  "NH4...uM.",
  "temp..degC.")

# for taxonomy
# sel_vars <- c("X8.day.seascapes",
#               "Acantharea",
#               "Copepods",
#               "Echinoderms",
#               "Jellies",
#               "Larvaceans",
#               "Polychaets",
#               "Chaetognaths",
#               "Pteropods")

# sel_vars <- c("X8.day.seascapes",
#               "Ceratium",
#               "Chaetoceros",
#               "Chain2",
#               "Chain3",
#               "Guinardia",
#               "Neocalyptrella",
#               "Tricho")

# sel_vars <- c("X8.day.seascapes",
#               "Acantharea",
#               "Copepods",
#               "Echinoderms",
#               "Jellies",
#               "Larvaceans",
#               "Polychaets",
#               "Chaetognaths",
#               "Pteropods",
#               "Ceratium",
#               "Chaetoceros",
#               "Chain2",
#               "Chain3",
#               "Guinardia",
#               "Neocalyptrella",
#               "Tricho")

# filter out rows with NA values in column seascapes
# df_filtered_pca <- taxa_meta[complete.cases(taxa_meta$X8.day.seascapes), ]
df_filtered_pca <- taxa_meta[complete.cases(taxa_meta[, sel_vars]), ]
# exclude_seascapes <- c(5, 7, 11)
exclude_seascapes <- 0
filt_df_pca <- df_filtered_pca[!df_filtered_pca$X8.day.seascapes %in%
                                 exclude_seascapes, sel_vars]

# Select numeric columns in filt_df_pca
numeric_cols <- sapply(filt_df_pca, is.numeric)
# Identify numeric columns except the first one
numeric_cols <- 2:ncol(filt_df_pca)

# Transform numeric columns to log scale
filt_df_pca[numeric_cols] <- lapply(filt_df_pca[numeric_cols], function(x) log(x + 1))


# pca <- prcomp(filt_df_pca[, c("salinity", "Avg.chl.a..ug.L.", "PO4...uM.", "NO3.NO2..uM.")], scale. = TRUE)
pca <- prcomp(filt_df_pca[, -1], scale. = TRUE)

# Extract PC1 and PC2 scores for each sampling event
# pc_scores <- data.frame(seascape = df_subset$X8.day.seascapes, # for taxonomic analysis 
pc_scores <- data.frame(seascape = as.character(filt_df_pca$X8.day.seascapes), # for hydrography
                        PC1 = pca$x[, 1], 
                        PC2 = pca$x[, 2])

# Create the plot
pc_scores$seascape <- factor(pc_scores$seascape, levels = c("3", "13", "15", "21", "27"))
bb <- ggplot(pc_scores, aes(x = PC1, y = PC2, color = seascape)) + 
  geom_point() +
  labs(x = "PC1", y = "PC2", color = "Seascape") 

# add circle around cluster of data points
# custom_colors_pca <- custom_pal_hex[c(1, 5, 6, 7, 8)]
custom_colors_pca <- custom_colors

yy <- ggplot(pc_scores, aes(x = PC1, y = PC2, color = seascape)) + 
  geom_point() +
  stat_ellipse(aes(fill = seascape), level = 0.90, geom = "polygon", alpha = 0.3, color = "black") +
  scale_color_manual(values = custom_colors_pca) +
  scale_fill_manual(values = custom_colors_pca) +
  theme_classic() +
  # xlim(-2,2) +
  # ylim(-2,2) +
  # xlim(-1,1) +
  # ylim(-1,1) +
  geom_point(size=2) +
  guides(colour = guide_legend(override.aes = list(size=2))) + 
  theme(axis.text.x = element_text(size = 32),  # Set X-axis label font size
        axis.text.y = element_text(size = 32)) +
  theme(axis.title.x = element_text(size = 32),
        axis.title.y = element_text(size = 32)) +
  theme(legend.text = element_text(size = 32))

yy

################################################################################################
# # Create PCA with eigenvectors
# Extract principal component scores
pc_scores2 <- pca$x
# Extract eigenvectors
eigenvectors <- pca$rotation
# Calculate the percentage variance explained by each principal component
total_variance <- sum(pca$sdev^2)
pc_var_percent <- round(100 * (pca$sdev^2) / total_variance, 1)

# Convert X8.day.seascapes to a factor
filt_df_pca$X8.day.seascapes <- as.factor(filt_df_pca$X8.day.seascapes)

# # For hydrography
qq <- ggplot(filt_df_pca, aes(x = pc_scores2[,1], y = pc_scores2[,2], color = X8.day.seascapes)) +
  geom_point(size = 5, alpha = 0.9) +
  scale_color_manual(values = custom_colors_pca, labels = seascape_labels) +
  geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 1], yend = eigenvectors[2, 1]),
               arrow = arrow(length = unit(0.1, "inches")), color = "black") +  # Add vector for PC1
  geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 2], yend = eigenvectors[2, 2]),
               arrow = arrow(length = unit(0.1, "inches")), color = "black") + # Add vector for PC2
  geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 3], yend = eigenvectors[2, 3]),
               arrow = arrow(length = unit(0.1, "inches")), color = "black") + # Add vector for PC3
  geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 4], yend = eigenvectors[2, 4]),
               arrow = arrow(length = unit(0.1, "inches")), color = "black") + # Add vector for PC4
  geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 5], yend = eigenvectors[2, 5]),
               arrow = arrow(length = unit(0.1, "inches")), color = "black") + # Add vector for PC5
  geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 6], yend = eigenvectors[2, 6]),
               arrow = arrow(length = unit(0.1, "inches")), color = "black") + # Add vector for PC6
  geom_text(aes(x = eigenvectors[1, 1], y = eigenvectors[2, 1], 
                label = paste("PC1 (", pc_var_percent[1], "%: Salinity)", sep = "")),
            vjust = -0.5, hjust = 0.5, color = "black", size = 6) +  # Add label for PC1
  geom_text(aes(x = eigenvectors[1, 2], y = eigenvectors[2, 2], 
                label = paste("PC2 (", pc_var_percent[2], "%: Chla)", sep = "")),
            vjust = -0.5, hjust = 0.5, color = "black", size = 6) +  # Add label for PC2
  geom_text(aes(x = eigenvectors[1, 3], y = eigenvectors[2, 3], 
                label = paste("PC3 (", pc_var_percent[3], "%: Phosphate)", sep = "")),
            vjust = -0.5, hjust = 0.5, color = "black", size = 6) +  # Add label for PC3
  geom_text(aes(x = eigenvectors[1, 4], y = eigenvectors[2, 4], 
                label = paste("PC4 (", pc_var_percent[4], "%: NOx)", sep = "")),
            vjust = -0.5, hjust = 0.5, color = "black", size = 6) +  # Add label for PC4
  geom_text(aes(x = eigenvectors[1, 5], y = eigenvectors[2, 5], 
                label = paste("PC5 (", pc_var_percent[5], "%: Ammonium)", sep = "")),
            vjust = -0.5, hjust = 0.5, color = "black", size = 6) +  # Add label for PC5
  geom_text(aes(x = eigenvectors[1, 6], y = eigenvectors[2, 6], 
                label = paste("PC6 (", pc_var_percent[6], "%: Temperature)", sep = "")),
            vjust = -0.5, hjust = 0.5, color = "black", size = 6) +  # Add label for PC6
  labs(x = "PC1", y = "PC2", color = "Seascape class") +
  xlim(-1.5, 1.5) +
  ylim(-1.5, 1.5) +
  guides(colour = guide_legend(title = NULL, override.aes = list(size=7))) + 
  theme_classic() +
  theme(axis.text.x = element_text(size = font_size),  # Set X-axis label font size
        axis.text.y = element_text(size = font_size)) +
  theme(axis.title.x = element_text(size = font_size),
        axis.title.y = element_text(size = font_size)) +
  theme(legend.text = element_text(size = font_size)) +
  theme(legend.title = element_text(size = font_size))
qq


# # # For phytoplankton
# qq2 <- ggplot(filt_df_pca, aes(x = pc_scores2[,1], y = pc_scores2[,3], color = X8.day.seascapes)) +
#   geom_point(size = 4) +
#   scale_color_manual(values = custom_colors_pca) +
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 1], yend = eigenvectors[2, 1]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") +  # Add vector for PC1
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 2], yend = eigenvectors[2, 2]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC2
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 3], yend = eigenvectors[2, 3]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC3
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 4], yend = eigenvectors[2, 4]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC4
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 5], yend = eigenvectors[2, 5]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC5
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 6], yend = eigenvectors[2, 6]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC6
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 7], yend = eigenvectors[2, 7]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC7
#   geom_text(aes(x = eigenvectors[1, 1], y = eigenvectors[2, 1], 
#                 label = paste("PC1 (", pc_var_percent[1], "%: Ceratium)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC1
#   geom_text(aes(x = eigenvectors[1, 2], y = eigenvectors[2, 2], 
#                 label = paste("PC2 (", pc_var_percent[2], "%: Chaetoceros)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC2
#   geom_text(aes(x = eigenvectors[1, 3], y = eigenvectors[2, 3], 
#                 label = paste("PC3 (", pc_var_percent[3], "%: Diatoms)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC3
#   geom_text(aes(x = eigenvectors[1, 4], y = eigenvectors[2, 4], 
#                 label = paste("PC4 (", pc_var_percent[4], "%: Diatoms2)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC4
#   geom_text(aes(x = eigenvectors[1, 5], y = eigenvectors[2, 5], 
#                 label = paste("PC5 (", pc_var_percent[5], "%: Guinardia)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC5
#   geom_text(aes(x = eigenvectors[1, 6], y = eigenvectors[2, 6], 
#                 label = paste("PC6 (", pc_var_percent[6], "%: Neocalyptrella)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC6
#   geom_text(aes(x = eigenvectors[1, 7], y = eigenvectors[2, 7], 
#                 label = paste("PC7 (", pc_var_percent[7], "%: Trichodesmium)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC7
#   labs(x = "PC1", y = "PC3", color = "X8.day.seascapes") +
#   xlim(-1, 1) +
#   ylim(-1, 1) +
#   guides(colour = guide_legend(override.aes = list(size=2))) + 
#   theme_classic() +
#   theme(axis.text.x = element_text(size = 32),  # Set X-axis label font size
#         axis.text.y = element_text(size = 32)) +
#   theme(axis.title.x = element_text(size = 32),
#         axis.title.y = element_text(size = 32)) +
#   theme(legend.text = element_text(size = 32)) 
# qq2
# 
# 
# # # For zooplankton
# qq3 <- ggplot(filt_df_pca, aes(x = pc_scores2[,1], y = pc_scores2[,2], color = X8.day.seascapes)) +
#   geom_point(size = 4) +
#   scale_color_manual(values = custom_colors_pca) +
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 1], yend = eigenvectors[2, 1]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") +  # Add vector for PC1
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 2], yend = eigenvectors[2, 2]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC2
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 3], yend = eigenvectors[2, 3]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC3
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 4], yend = eigenvectors[2, 4]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC4
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 5], yend = eigenvectors[2, 5]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC5
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 6], yend = eigenvectors[2, 6]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC6
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 7], yend = eigenvectors[2, 7]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC7
#   geom_segment(aes(x = 0, y = 0, xend = eigenvectors[1, 8], yend = eigenvectors[2, 8]),
#                arrow = arrow(length = unit(0.2, "inches")), color = "black") + # Add vector for PC8
#   geom_text(aes(x = eigenvectors[1, 1], y = eigenvectors[2, 1], 
#                 label = paste("PC1 (", pc_var_percent[1], "%: Acantharea)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC1
#   geom_text(aes(x = eigenvectors[1, 2], y = eigenvectors[2, 2], 
#                 label = paste("PC2 (", pc_var_percent[2], "%: Copepods)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC2
#   geom_text(aes(x = eigenvectors[1, 3], y = eigenvectors[2, 3], 
#                 label = paste("PC3 (", pc_var_percent[3], "%: Echinoderms)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC3
#   geom_text(aes(x = eigenvectors[1, 4], y = eigenvectors[2, 4], 
#                 label = paste("PC4 (", pc_var_percent[4], "%: Jellies)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC4
#   geom_text(aes(x = eigenvectors[1, 5], y = eigenvectors[2, 5], 
#                 label = paste("PC5 (", pc_var_percent[5], "%: Larvaceans)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC5
#   geom_text(aes(x = eigenvectors[1, 6], y = eigenvectors[2, 6], 
#                 label = paste("PC6 (", pc_var_percent[6], "%: Polychaetes)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC6
#   geom_text(aes(x = eigenvectors[1, 7], y = eigenvectors[2, 7], 
#                 label = paste("PC7 (", pc_var_percent[7], "%: Chaetognaths)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC7
#   geom_text(aes(x = eigenvectors[1, 8], y = eigenvectors[2, 8], 
#                 label = paste("PC8 (", pc_var_percent[8], "%: Pteropods)", sep = "")),
#             vjust = -0.5, hjust = 0.5, color = "black") +  # Add label for PC8
#   labs(x = "PC1", y = "PC2", color = "X8.day.seascapes") +
#   xlim(-1, 1) +
#   ylim(-1, 1) +
#   guides(colour = guide_legend(override.aes = list(size=2))) + 
#   theme_classic() +
#   theme(axis.text.x = element_text(size = 32),  # Set X-axis label font size
#         axis.text.y = element_text(size = 32)) +
#   theme(axis.title.x = element_text(size = 32),
#         axis.title.y = element_text(size = 32)) +
#   theme(legend.text = element_text(size = 32)) 
# qq3

# ggsave("seascape_pca_hydro.jpeg", plot = qq, width = 14, height = 9, device = "jpeg")

```


# Map overall WEIGHTED mean concentration values of selected taxa by transect
```{r}
# install.packages("svglite")
library(ggOceanMaps)
library(leaflet)
# library(patchwork)

# List of class names
# Acantharea, Chaetognaths, Ostracods, Copepods, Decapods, Echinoderms, Jellies, Larvaceans, Polychaets, Pteropods
# Centric, Ceratium, Chaetoceros, Chain2, Chain3, Guinardia, Neocalyptrella, Noctiluca, Tricho
selected_class <- "Chain2"

# Create df for selected group
taxa_meta_concentration <- taxa_meta %>%
  mutate(across(all_of(selected_class), ~ . / total_vol_sampled * 1e6)) %>%
  select(Station, dec_lat, dec_lon, year, month, date, total_vol_sampled, all_of(selected_class)) %>%
  filter(!is.na(total_vol_sampled))

# Get station coordinates
path_sfer_list <- "~/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/manuscripts/montes_etal_cpics/"
sfer_curated <- list.files(path_sfer_list, pattern = "sfer_stations_curated_w_fwc_stations.csv", full.names = TRUE)
sfer_sta_list <- read.csv(sfer_curated, header = TRUE)

    # # Merges curated station list with the concentration df
    concentration_df <- taxa_meta_concentration %>%
      left_join(sfer_sta_list %>% filter(station_class %in% "C"), by = c('Station' = 'station_id')) %>%
      filter(get(selected_class) > 0)  # Exclude rows where the species count is zero
    
    # Compute weighted average lat/lons and mean variable values for the current class
    taxa_concentration_avg <- concentration_df %>%
      group_by(line_id) %>%
      mutate(weight = get(selected_class) / sum(get(selected_class), na.rm = TRUE)) %>%
      summarise(longitude = weighted.mean(dec_lon, w = weight, na.rm = TRUE),
                latitude = weighted.mean(dec_lat, w = weight, na.rm = TRUE),
                sel_taxa_mean = mean(get(selected_class), na.rm = TRUE),
                sel_taxa_sd = sd(get(selected_class), na.rm = TRUE))

    # Prepare data for mapping
    dt <- data.frame(
      lon = taxa_concentration_avg$longitude, 
      lat = taxa_concentration_avg$latitude, 
      mean_param = taxa_concentration_avg$sel_taxa_mean,
      sd_param = taxa_concentration_avg$sel_taxa_sd) %>%
    mutate(sd_param = replace_na(sd_param, 0))
    
    # Add station markers
    station_markers <- sfer_sta_list %>% filter(station_class %in% "C")
    
    # Create the map
    concentration_map <- basemap(limits = c(-86, -79.5, 24, 29), bathymetry = TRUE) +
      # geom_point(data = dt, aes(x = lon, y = lat, size = log10(mean_param+1), color = log10(sd_param+1))) +
      geom_point(data = dt, aes(x = lon, y = lat, size = mean_param, color = sd_param)) +
      scale_color_gradient(low = "yellow", high = "red", na.value = NA, name = "Standard Deviation") +
      geom_point(data = station_markers, aes(x = mean_lon, y = mean_lat), color = "black", shape = 3, size = 1.5) +
      scale_size_continuous(name = "Average concentration", 
                            # breaks = c(2000, 4000, 6000),
                            range = c(0, 10),
                            guide = guide_legend(override.aes = list(color = "black", fill = "white"))) +
    theme_minimal() +
    ggtitle(paste(selected_class))
      
    # Optionally, save each map as an image
    # ggsave(paste0("conc_map_weighted_", selected_class, ".png"), plot = concentration_map, width = 8, height = 6)
    # ggsave(paste0("conc_map_weighted_", selected_class, ".svg"), plot = concentration_map, width = 8, height = 6, device = "svg")
    
    print(concentration_map)
```


# Map overall mean concentration values of selected taxa per station
```{r}
library(ggOceanMaps)

# List of class names
# Acantharea, Chaetognaths, Ostracods, Copepods, Decapods, Echinoderms, Jellies, Larvaceans, Polychaets, Pteropods, pellets
# Centric, Ceratium, Chaetoceros, Chain2, Chain3, Guinardia, Neocalyptrella, Noctiluca, Tricho
selected_class <- "Tricho"

taxa_meta_concentration <- taxa_meta %>%
  mutate(across(all_of(selected_class), ~ . / total_vol_sampled * 1e6)) %>%
  select(Station, dec_lat, dec_lon, year, month, date, total_vol_sampled, all_of(selected_class)) %>%
  filter(!is.na(total_vol_sampled)) 

# Exclude rows where selected_class equals 0
taxa_meta_concentration <- taxa_meta_concentration %>%
  filter(get(selected_class) > 0)

# Use this to select a specific time period
# taxa_meta_concentration <- taxa_meta_concentration %>% filter(year == 2023 & month == 7)

# Compute mean concentration of selected groups per station
taxa_concentration_avg_station <- taxa_meta_concentration %>%
  group_by(Station) %>%
  summarise(longitude_station = mean(dec_lon, na.rm = TRUE),
            latitude_station = mean(dec_lat, na.rm = TRUE),
            sel_taxa_mean_station = mean(get(selected_class), na.rm = TRUE),
            sel_taxa_sd_station = sd(get(selected_class), na.rm = TRUE))

# Get station coordinates
path_sfer_list <- "~/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/manuscripts/montes_etal_cpics/"
sfer_curated <- list.files(path_sfer_list, pattern = "sfer_stations_curated_w_fwc_stations.csv", full.names = TRUE)
sfer_sta_list <- read.csv(sfer_curated, header = TRUE)

# # Map with bathymetry
  # Overlay color-scaled dots
dt_station <- data.frame(
  lon_station = taxa_concentration_avg_station$longitude_station, 
  lat_station = taxa_concentration_avg_station$latitude_station, 
  mean_param_station = taxa_concentration_avg_station$sel_taxa_mean_station,
  sd_param_station = taxa_concentration_avg_station$sel_taxa_sd_station)

# Replace NA by zeros
dt_station <- dt_station %>%
  mutate(sd_param_station = replace_na(sd_param_station, 0))

# Add station markers
station_markers <- sfer_sta_list %>% filter(station_class %in% "C")
    
concentration_map_station <- basemap(limits = c(-86, -79.5, 24, 29), bathymetry = TRUE) +
  geom_point(data = dt_station, aes(x = lon_station, 
                                    y = lat_station, 
                                    size = mean_param_station, 
                                    color = sd_param_station)) +
  scale_color_gradient(low = "yellow", high = "red", na.value = NA, name = "Standard Deviation") +
  geom_point(data = station_markers, aes(x = mean_lon, y = mean_lat), color = "black", shape = 3, size = 1.5) +
  scale_size_continuous(name = "Average concentration", 
                        # breaks = c(250, 500, 750),
                        range = c(1, 10),
                        guide = guide_legend(override.aes = list(color = "black", fill = "white"))) +
  theme_minimal() 

# Optionally, save each map as an image
# ggsave(paste0("conc_map_station_", selected_class, ".png"), plot = concentration_map_station, width = 8, height = 6)
# ggsave(paste0("conc_map_station_", selected_class, ".svg"), plot = concentration_map_station, width = 8, height = 6, device = "svg")
print(concentration_map_station)

write.csv(dt_station, paste0("df_",selected_class,".csv"), row.names = FALSE)
print(max(dt_station$mean_param_station))
```


# Map mean count values of selected taxa and specified dates
```{r}
# # ggOceanMaps:
# https://biostats-r.github.io/biostats/workingInR/140_maps.html
# https://github.com/MikkoVihtakari/ggOceanMaps: Use this one: remotes::install_github("MikkoVihtakari/ggOceanMaps")
# install.packages("ggOceanMaps") # # This is outdated, don't use!!!
library(ggOceanMaps)
library(leaflet)

# For NOAA machines
# path_sfer_list <- "/Users/enrique.montes/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/proposals/2022_02_MultiStressor_NOAA/module_1"
# For personal machine
path_sfer_list <- "~/Library/CloudStorage/GoogleDrive-enriquemontes01@gmail.com/My Drive/GDrive/manuscripts/montes_etal_cpics/"

sfer_curated <- list.files(path_sfer_list, pattern = "sfer_stations_curated_w_fwc_stations.csv", full.names = TRUE)

sfer_sta_list <- read.csv(sfer_curated, header = TRUE)

merged_data <- taxa_meta %>%
  left_join(sfer_sta_list %>% filter(station_class %in% "C"), by = c('Station' = 'station_id'))

# Replace 2023 and 10 with your selected year and month
selected_year <- 2023
selected_month <- 11

# Filter rows
filtered_taxa_meta <- merged_data %>%
  filter(year == selected_year, month == selected_month)

# filtered_taxa_meta <- merged_data

# Compute weighted average lat lons based on selected variable, and mean variable values (e.g., Copepods)
taxa_avg <- filtered_taxa_meta %>%
  group_by(line_id) %>%
  mutate(weight = Guinardia / sum(Guinardia, na.rm = TRUE)) %>%
  summarise(longitude = weighted.mean(dec_lon, w = weight, na.rm = TRUE),
            latitude = weighted.mean(dec_lat, w = weight, na.rm = TRUE),
            sel_taxa_mean = mean(Guinardia, na.rm = TRUE))

# # Filter out values less than 1
filtered_taxa_avg <- taxa_avg %>%
  filter(sel_taxa_mean > 0)


# Find the minimum and maximum values of sel_taxa_mean
min_value <- min(filtered_taxa_avg$sel_taxa_mean, na.rm = TRUE)
max_value <- max(filtered_taxa_avg$sel_taxa_mean, na.rm = TRUE)

# # Adjust the color palette with specified values
# color_palette <- colorNumeric(palette = "Oranges", domain = c(min_value, max_value))

# # Create the map
# map <- leaflet(filtered_taxa_avg) %>%
#   addProviderTiles("Esri.WorldImagery") %>%
#   addCircleMarkers(
#     lng = ~longitude,
#     lat = ~latitude,
#     radius = 10,
#     color = ~color_palette(sel_taxa_mean),
#     fillOpacity = 0.8,
#     popup = ~paste("Line ID: ", line_id, "<br>Copepods: ", sel_taxa_mean)
#   ) %>%
#   addLegend(
#     position = "bottomright",
#     pal = color_palette,
#     values = c(min_value, max_value),  # Adjusted values here
#     title = "Copepod occurrences",
#     opacity = 1
#   )
# map

# # Map with bathymetry
  # Overlay color-scaled dots
dt <- data.frame(
  lon = filtered_taxa_avg$longitude, 
  lat = filtered_taxa_avg$latitude, 
  sel_param = filtered_taxa_avg$sel_taxa_mean)

# # Colors:
# Acantharea = darkturquoise; breaks = c(0.25, 1, 2.5, 5); limits = c(0.1, 10)
# Copepods = red; breaks = c(0.25, 1, 2.5, 5, 10); limits = c(0.1, 15)
# Chain diatoms = orange; breaks = c(0.5, 1, 10, 30, 60); c(0.1, 70)
# Chaetoceros = purple; breaks = c(0.25, 1, 2.5, 5, 10); limits = c(0.1, 15)
# Echinoderms = magenta; breaks = c(0.5, 1, 3, 5); limits = c(0.1, 5)
# Larvaceans = plum; breaks = c(0.5, 1, 3, 5); limits = c(0.1, 5)
# Polychaetes = dodgerblue; breaks = c(0.25, 0.5, 1, 3); limits = c(0.1, 3)
# Jellies = slategray4; breaks = c(0.25, 0.5, 1, 2); limits = c(0.1, 3)
    
occ_map <- basemap(limits = c(-84, -79.5, 24, 28.5), bathymetry = TRUE) +
  geom_point(data = dt, aes(x = lon, y = lat, size = sel_param), fill = "olivedrab2", color = "olivedrab2") +
  geom_point(data = filtered_taxa_meta, aes(x = dec_lon, y = dec_lat), color = "black", shape = 3, size = 1.5) +
  scale_size_continuous(name = "Average counts", 
                        breaks = c(0.5, 1, 3, 5, 10),
                        limits = c(0.1, 40),
                        range = c(1, 15)) +
  theme_minimal() 
occ_map

# occ_map_leg <- ggplot(dt, aes(lon, lat)) +
#   geom_point(aes(size = sel_param), fill = "green", color ="green") +
#   theme_minimal()
# occ_map_leg
```


# Create time-series plots of selected taxa at specific stations
```{r}
selected_variable <- 'Chaetoceros'
# # Lower Keys
# selected_line_id <- c('LK','WS','MO','KW')
# # Middle Keys
# selected_line_id <- c('CO', 'CR')
# # Other regions
selected_line_id <- c('CAL')

# Filter the data for the selected line_id
filtered_merged_data <- merged_data[merged_data$line_id %in% selected_line_id, ]
# Remove rows with NAs in relevant columns
monthly_means <- na.omit(filtered_merged_data[, c("date", selected_variable, "line_id")]) %>%
  group_by(year_month = format(date, "%Y-%m")) %>%
  summarise(mean_value = mean(!!sym(selected_variable), na.rm = TRUE),
             se_value = sd(!!sym(selected_variable), na.rm = TRUE) / sqrt(n()))

# Create a time series plot
ggplot(monthly_means, aes(x = year_month, y = mean_value)) +
  geom_bar(stat = "identity", fill = "orange") +
  geom_errorbar(aes(ymin = mean_value - se_value, ymax = mean_value + se_value),
                width = 0.2, # Adjust width as needed
                position = position_dodge(width = 0.8)) + # Adjust width as needed
  labs(x = "Year-Month", y = "Mean Value") +
  ggtitle("Monthly Means of Selected Variable") +
  theme_minimal()

```

# Create a table with min/max values for selected params per group
```{r}
taxa_meta_concentration_all <- taxa_meta %>%
  mutate(across(c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
                   Noctiluca,Tricho,Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,Jellies,
    Larvaceans,Polychaets,Pteropods), ~ ./total_vol_sampled * 1e6)) %>%
  select(Station, dec_lat, dec_lon, year, month, date, total_vol_sampled,Avg.chl.a..ug.L.,
         temp..degC., salinity, DO..mg.L.,NH4...uM.,PO4...uM.,NO3.NO2..uM., Si.....uM.,
         Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
                   Noctiluca,Tricho,Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,
         Jellies,Larvaceans,Polychaets,Pteropods) %>%
  filter(!is.na(total_vol_sampled)) 

# # Transform taxa_meta_concentration to long format
taxa_meta_long_all <- taxa_meta_concentration_all %>%
  pivot_longer(cols = c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
                   Noctiluca,Tricho,Acantharea, Chaetognaths,Ostracods,Copepods,Decapods,
                        Echinoderms, Jellies, Larvaceans,Polychaets, Pteropods),
               names_to = "species", values_to = "species_concentration")

# List to store each species' summary row
summary_list <- list()

# Get unique species
species_vec <- unique(taxa_meta_long_all$species)

# Loop over species
for (sp in species_vec) {
  sub_df <- taxa_meta_long_all[taxa_meta_long_all$species == sp, ] %>%
    filter(species_concentration > 0)
  summary_row <- data.frame(
    species = sp,
    min_sp_concentration = min(sub_df$species_concentration, na.rm = TRUE),
    max_sp_concentration = max(sub_df$species_concentration, na.rm = TRUE),
    min_temp = min(sub_df$temp..degC., na.rm = TRUE),
    max_temp = max(sub_df$temp..degC., na.rm = TRUE),
    min_salinity = min(sub_df$salinity, na.rm = TRUE),
    max_salinity = max(sub_df$salinity, na.rm = TRUE),
    min_do = min(sub_df$DO..mg.L., na.rm = TRUE),
    max_do = max(sub_df$DO..mg.L., na.rm = TRUE),
    min_chl = min(sub_df$Avg.chl.a..ug.L., na.rm = TRUE),
    max_chl = max(sub_df$Avg.chl.a..ug.L., na.rm = TRUE),
    min_nh4 = min(sub_df$NH4...uM., na.rm = TRUE),
    max_nh4 = max(sub_df$NH4...uM., na.rm = TRUE),
    min_nox = min(sub_df$NO3.NO2..uM., na.rm = TRUE),
    max_nox = max(sub_df$NO3.NO2..uM., na.rm = TRUE),
    min_po4 = min(sub_df$PO4...uM., na.rm = TRUE),
    max_po4 = max(sub_df$PO4...uM., na.rm = TRUE),
    min_si = min(sub_df$Si.....uM., na.rm = TRUE),
    max_si = max(sub_df$Si.....uM., na.rm = TRUE)
  )
  summary_list[[length(summary_list)+1]] <- summary_row
}

# Combine all rows into a single data frame
summary_table <- do.call(rbind, summary_list)

# Print the table
print(summary_table)

write.csv(summary_table, file = 'table1.csv', row.names = FALSE)
```

# # Prepare data frames for CV analysis below with mean plankton densities per seascape using station data (same results as above)
```{r}
taxa_meta_concentration_all_seascapes <- taxa_meta %>%
  mutate(across(c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
                   Noctiluca,Tricho,Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,Jellies,
    Larvaceans,Polychaets,Pteropods), ~ ./total_vol_sampled * 1e6)) %>%
  select(Station, dec_lat, dec_lon, year, month, date, total_vol_sampled,Avg.chl.a..ug.L.,
         temp..degC., salinity, DO..mg.L.,NH4...uM.,PO4...uM.,NO3.NO2..uM., Si.....uM.,X8.day.seascapes,
         Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
                   Noctiluca,Tricho,Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,
         Jellies,Larvaceans,Polychaets,Pteropods) %>%
  filter(!is.na(total_vol_sampled)) 

# # Transform taxa_meta_concentration to long format
taxa_meta_long_all_seascapes <- taxa_meta_concentration_all_seascapes %>%
  pivot_longer(cols = c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,Neocalyptrella,
                   Noctiluca,Tricho,Acantharea, Chaetognaths,Ostracods,Copepods,Decapods,
                        Echinoderms, Jellies, Larvaceans,Polychaets, Pteropods),
               names_to = "species", values_to = "species_concentration")

summary_tbl_concentrations_seascapes <- taxa_meta_long_all_seascapes %>%
  group_by(X8.day.seascapes, species) %>%
  summarise(
    mean_species_concentration = mean(species_concentration[species_concentration != 0], na.rm = TRUE), 
    sd_species_concentration = sd(species_concentration[species_concentration != 0], na.rm = TRUE)
  ) %>%
  ungroup()

# filter table by group of species
summary_tbl_filtered <- summary_tbl_concentrations_seascapes %>%
  # filter(species %in% c("Centric","Ceratium","Chaetoceros","Chain2","Chain3","Guinardia","Neocalyptrella", "Noctiluca","Tricho")) %>%
    filter(species %in% c("Acantharea","Chaetognaths","Ostracods","Copepods","Decapods","Echinoderms","Jellies","Larvaceans","Polychaets","Pteropods")) %>%
  filter(!is.na(X8.day.seascapes)) %>%
  filter(!is.nan(mean_species_concentration))

print(summary_tbl_filtered)
```

# # Create plots showing coefficient of variation of plankton ABUNDANCE per seascape
```{r}
coeff_var <- summary_tbl_filtered %>%
  mutate(coef_var = sd_species_concentration / mean_species_concentration)

coeff_var$seascape_class <- factor(coeff_var$X8.day.seascapes,
                                   levels = c(3, 11, 13, 15, 21, 27),
                                   labels = c("TST", "TSU", "SGMI", "TS", "WBHN", "HE"))

# species_labels <- c(
#   "Centric" = "Cos",
#   "Ceratium" = "Cer",
#   "Chaetoceros" = "Cha",
#   "Chain2" = "Dia",
#   "Chain3" = "Ske",
#   "Guinardia" = "Gui",
#   "Neocalyptrella" = "Neo",
#   "Noctiluca" = "Hem",
#   "Tricho" = "Tri"
# )

species_labels <- c(
  "Acantharea" = "Aca",
  "Chaetognaths" = "Cha",
  "Copepods" = "Cop",
  "Decapods" = "Dec",
  "Echinoderms" = "Ech",
  "Jellies" = "Gel",
  "Larvaceans" = "Lar",
  "Ostracods" = "Ost",
  "Polychaets" = "Pol",
  "Pteropods" = "Pte"
)

coeff_var <- coeff_var %>%
  mutate(species = recode(species, !!!species_labels))

# species_order <- c(
#   "Hem",
#   "Cer",
#   "Tri",
#   "Neo",
#   "Cha",
#   "Cos",
#   "Gui",
#   "Dia",
#   "Ske"
# )

species_order <- c(
  "Ost",
  "Cha",
  "Pol",
  "Dec",
  "Gel",
  "Pte",
  "Aca",
  "Lar",
  "Ech",
  "Cop"
)

coeff_var$species <- factor(coeff_var$species, levels = rev(species_order))

heatmap <- ggplot(coeff_var, aes(x = seascape_class, y = species, fill = coef_var)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkred", limits = c(0.02,4.5), name = "CV") + 
  theme_minimal() +
  labs(x = NULL, y = NULL) +
  theme(
    axis.text.x  = element_text(size = 32, angle = 0, color = "black"),
    # axis.text.y  = element_text(size = 22, color = "black"),
    panel.grid = element_blank()
  ) +
  theme(legend.text = element_text(size = 18)) +
  theme(legend.title = element_text(size = 22)) 
heatmap

# ggsave("phyto_cv_v3.svg", plot = heatmap, width = 16, height = 7.25, device = "svg")
# ggsave("zoopl_cv_v3.svg", plot = heatmap, width = 16, height = 8, device = "svg")
```


# # Create plots showing coefficient of variation of plankton RELATIVE CONCENTRATION per seascape
```{r}
# Calculate relative abundances per class for each cruise using year and month
tmp_summary_relabund <- taxa_meta_long_all_seascapes %>%
    # filter(species %in% c("Centric","Ceratium","Chaetoceros","Chain2","Chain3","Guinardia","Neocalyptrella", "Noctiluca","Tricho")) %>%
      filter(species %in% c("Acantharea","Chaetognaths","Ostracods","Copepods","Decapods","Echinoderms","Jellies","Larvaceans","Polychaets","Pteropods")) %>%
  group_by(year, month, X8.day.seascapes) %>%
  mutate(relative_abundance = species_concentration / sum(species_concentration, na.rm = TRUE)) %>%
  group_by(year, month, X8.day.seascapes, species) %>%
  summarise(total_relative_abundance = sum(relative_abundance, na.rm = TRUE)) %>%
  ungroup()


# Calculate mean, sd, and cv of relative abundance per seascape
cv_summary_relabund <- tmp_summary_relabund %>%
  group_by(X8.day.seascapes, species) %>%
  summarise(
    mean_relabund = mean(total_relative_abundance[total_relative_abundance != 0], na.rm = TRUE),
    sd_relabund = sd(total_relative_abundance[total_relative_abundance != 0], na.rm = TRUE),
    coef_var_relabund = sd_relabund / mean_relabund
  ) %>%
  ungroup() %>%
  filter(!is.na(X8.day.seascapes)) %>%
  filter(!is.nan(mean_relabund))

cv_summary_relabund$seascape_class <- factor(cv_summary_relabund$X8.day.seascapes,
                                   levels = c(3, 11, 13, 15, 21, 27),
                                   labels = c("TST", "TSU", "SGMI", "TS", "WBHN", "HE"))

# species_labels <- c(
#   "Centric" = "Cos",
#   "Ceratium" = "Cer",
#   "Chaetoceros" = "Cha",
#   "Chain2" = "Dia",
#   "Chain3" = "Ske",
#   "Guinardia" = "Gui",
#   "Neocalyptrella" = "Neo",
#   "Noctiluca" = "Hem",
#   "Tricho" = "Tri"
# )

species_labels <- c(
  "Acantharea" = "Aca",
  "Chaetognaths" = "Cha",
  "Copepods" = "Cop",
  "Decapods" = "Dec",
  "Echinoderms" = "Ech",
  "Jellies" = "Gel",
  "Larvaceans" = "Lar",
  "Ostracods" = "Ost",
  "Polychaets" = "Pol",
  "Pteropods" = "Pte"
)

cv_summary_relabund <- cv_summary_relabund %>%
  mutate(species = recode(species, !!!species_labels))

# species_order <- c(
#   "Hem",
#   "Cer",
#   "Tri",
#   "Neo",
#   "Cha",
#   "Cos",
#   "Gui",
#   "Dia",
#   "Ske"
# )

species_order <- c(
  "Ost",
  "Cha",
  "Pol",
  "Dec",
  "Gel",
  "Pte",
  "Aca",
  "Lar",
  "Ech",
  "Cop"
)

cv_summary_relabund$species <- factor(cv_summary_relabund$species, levels = rev(species_order))

heatmap <- ggplot(cv_summary_relabund, aes(x = seascape_class, y = species, fill = coef_var_relabund)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkgreen", limits = c(0.02,3), name = "CV") +
  theme_minimal() +
  labs(x = NULL, y = NULL) +
  theme(
    axis.text.x  = element_text(size = 32, angle = 0, color = "black"),
    # axis.text.y  = element_text(size = 22, color = "black"),
    panel.grid = element_blank()
  ) +
  theme(legend.text = element_text(size = 18)) +
  theme(legend.title = element_text(size = 22))
heatmap

# ggsave("phyto_cv_relabund_v3.svg", plot = heatmap, width = 16, height = 7.25, device = "svg")
# ggsave("zoopl_cv_relabund_v3.svg", plot = heatmap, width = 16, height = 8, device = "svg")
```

# # Check number of counts per focus threshold and deployment times
```{r}
taxa_counts <- taxa_meta %>%
  select(Station, dec_lat, dec_lon, year, month, date, conc_deployDurMin, focus_threshold,
         Acantharea,Chaetognaths,Ostracods,Copepods,Decapods,Echinoderms,
         Jellies,Larvaceans,Polychaets,Pteropods) %>%
  # select(Station, dec_lat, dec_lon, year, month, date, conc_deployDurMin, focus_threshold,
  #        Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,
  #        Neocalyptrella,Noctiluca,Tricho) %>%
  filter(!is.na(conc_deployDurMin))

# # Transform taxa_meta_concentration to long format
taxa_counts_long <- taxa_counts %>%
  pivot_longer(cols = c(Acantharea, Chaetognaths,Ostracods,Copepods,Decapods,
                        Echinoderms, Jellies, Larvaceans,Polychaets, Pteropods),
  # pivot_longer(cols = c(Centric,Ceratium,Chaetoceros,Chain2,Chain3,Guinardia,
  #                       Neocalyptrella,Noctiluca,Tricho),
               names_to = "species", values_to = "species_counts") %>%
  filter(species_counts > 0)

taxa_counts_summary <- taxa_counts_long %>%
  group_by(focus_threshold, conc_deployDurMin) %>%
  summarise(counts = sum(species_counts)) %>%
  ungroup()

count_plot <- ggplot(data = taxa_counts_summary, aes(x = conc_deployDurMin, y = counts, color = focus_threshold)) +
  geom_point(size=5, alpha=0.5) +
  scale_color_viridis_c(name = "Focus threshold", option = "inferno", limits = c(0.7, 1)) +
  # scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(1e0, 1e3)) +
  xlim(0, 20) +
  ylim(0,50) +
  labs(title = "Zooplankton", x = 'Duration (min)', y = 'Counts') +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 32, color = "black"),
    axis.text.x = element_text(size = 32, color = "black"),
    axis.title.x = element_text(size = 32, color = "black", margin = margin(t = 20)),
    axis.title.y = element_text(size = 32, color = "black", margin = margin(r = 32)),
    axis.text.y = element_text(size = 32, color = "black"),
    axis.line = element_line(color = "black"),
    legend.text = element_text(size = 22, color = "black"),
    legend.title = element_text(size = 22, color = "black", margin = margin(b = 15)))
count_plot

ggsave("focus_thres_zoopl.svg", plot = count_plot, width = 16, height = 8, device = "svg")

```
